"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[2762],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>d});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),m=c(n),d=i,f=m["".concat(s,".").concat(d)]||m[d]||p[d]||o;return n?a.createElement(f,r(r({ref:t},u),{},{components:n})):a.createElement(f,r({ref:t},u))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var c=2;c<o;c++)r[c]=n[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},4816:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var a=n(7462),i=(n(7294),n(3905));const o={sidebar_position:2,title:"Changing Config"},r=void 0,l={unversionedId:"reference-manual/structured-configs/changing-config",id:"reference-manual/structured-configs/changing-config",title:"Changing Config",description:"Most .yaml configs used in classy simply define the parameters that are passed at construction time to actual Python",source:"@site/docs/reference-manual/structured-configs/changing-config.md",sourceDirName:"reference-manual/structured-configs",slug:"/reference-manual/structured-configs/changing-config",permalink:"/classy/docs/reference-manual/structured-configs/changing-config",draft:!1,editUrl:"https://github.com/sunglasses-ai/classy/edit/main/docs/docs/reference-manual/structured-configs/changing-config.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,title:"Changing Config"},sidebar:"tutorialSidebar",previous:{title:"Overall Structure",permalink:"/classy/docs/reference-manual/structured-configs/overall-structure"},next:{title:"Visualizing your configuration",permalink:"/classy/docs/reference-manual/structured-configs/visualize"}},s={},c=[{value:"Changing values",id:"changing-values",level:2},{value:"Writing a new config",id:"writing-a-new-config",level:2},{value:"Lazy Instantiation",id:"lazy-instantiation",level:2}],u={toc:c};function p(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Most ",(0,i.kt)("inlineCode",{parentName:"p"},".yaml")," configs used in ",(0,i.kt)("inlineCode",{parentName:"p"},"classy")," simply define the parameters that are passed at construction time to actual Python\nobjects. For instance, the following config:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="configurations/model/token.yaml"',title:'"configurations/model/token.yaml"'},"_target_: 'classy.pl_modules.hf.HFTokensPLModule'\ntransformer_model: ${transformer_model}\nuse_last_n_layers: 1\nfine_tune: True\n")),(0,i.kt)("p",null,"refers to the instantiation of the following object:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="classy/pl_modules/hf/classification.py"',title:'"classy/pl_modules/hf/classification.py"'},"class HFTokensPLModule(...):\n\n    def __init__(\n        self,\n        transformer_model: str,\n        use_last_n_layers: int,\n        fine_tune: bool,\n    ):\n        ...\n")),(0,i.kt)("p",null,"In particular, the ",(0,i.kt)("inlineCode",{parentName:"p"},"_target_")," property defines the object to be instantiated by specifying the Python module path to\nthe corresponding object."),(0,i.kt)("p",null,"To actually instantiate configs, you can use Hydra ",(0,i.kt)("inlineCode",{parentName:"p"},"instantiate")," method:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"import hydra\n\n# conf is expected to be a DictConfig object (essentially a more powerful Python Dict loaded via OmegaConf); you don't need to care about this detail\nhydra.utils.instantiate(conf)\n")),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"By default, the instantiation process is recursive. You can change this behavior with the ",(0,i.kt)("inlineCode",{parentName:"p"},"_recursive_")," parameter.")),(0,i.kt)("h2",{id:"changing-values"},"Changing values"),(0,i.kt)("p",null,"With this in mind, you can see how easy it is to change things. For instance, if you want to change the fine-tuning behavior\nas in the previous Section, you just need to change the ",(0,i.kt)("inlineCode",{parentName:"p"},".yaml")," file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="configurations/model/token.yaml"',title:'"configurations/model/token.yaml"'},"_target_: 'classy.pl_modules.hf.HFTokensPLModule'\ntransformer_model: ${transformer_model}\nuse_last_n_layers: 1\nfine_tune: False\n")),(0,i.kt)("p",null,"and this will reflect automatically on your instantiated HFTokensPLModule."),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"Having to enter the configuration folder, open the yaml file, edit the desired field and start the run every time\ncan be a bit of a nuisance, especially if you then have to revert your changes if you get worse results.\nTo avoid this, for simple modifications, you can use the ",(0,i.kt)("inlineCode",{parentName:"p"},"-c")," option of classy train, to provide Hydra CLI overrides on params. For\ninstance, to change the fine-tuning strategy, ",(0,i.kt)("inlineCode",{parentName:"p"},"classy train ... -c model.fine_tune=False"),".")),(0,i.kt)("h2",{id:"writing-a-new-config"},"Writing a new config"),(0,i.kt)("p",null,"Similarly, if you want to write a new config, perhaps specifying a new super-cool model, you just need to specify what to instantiate\n(the ",(0,i.kt)("inlineCode",{parentName:"p"},"_target_")," param) and how (the other params) to instantiate it:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="configurations/model/model-new.yaml"',title:'"configurations/model/model-new.yaml"'},"_target_: <python-module-path-to-object>\nparam1: value1\nparam2: value2\n...\n")),(0,i.kt)("h2",{id:"lazy-instantiation"},"Lazy Instantiation"),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"This section involves fairly complex concepts. Feel free to skip it if you are not planning on extensively\nediting ",(0,i.kt)("inlineCode",{parentName:"p"},"classy")," configs for the moment.")),(0,i.kt)("p",null,"Things are usually as simple as described above. However, actual instantiation sometimes requires resources that you\ncannot specify in the ",(0,i.kt)("inlineCode",{parentName:"p"},".yaml")," config. For instance, the actual configuration and code of ",(0,i.kt)("inlineCode",{parentName:"p"},"HFTokensPLModule")," is the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="configurations/model/token.yaml"',title:'"configurations/model/token.yaml"'},"_target_: 'classy.pl_modules.hf.HFTokensPLModule'\ntransformer_model: ${transformer_model}\nuse_last_n_layers: 1\nfine_tune: True\noptim_conf:\n  _target_: classy.optim.factories.RAdamWithDecayFactory\n  lr: 1e-5\n  weight_decay: 0.01\n  no_decay_params:\n    - bias\n    - LayerNorm.weight\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="classy/pl_modules/hf/token.py"',title:'"classy/pl_modules/hf/token.py"'},"class HFTokensPLModule(...):\n\n    def __init__(\n        self,\n        transformer_model: str,\n        use_last_n_layers: int,\n        fine_tune: bool,\n        vocabulary: Vocabulary,  # <--\n        optim_conf: omegaconf.DictConfig,\n    ):\n        ...\n")),(0,i.kt)("p",null,"with ",(0,i.kt)("inlineCode",{parentName:"p"},"__init__")," having two additional ",(0,i.kt)("em",{parentName:"p"},"problematic")," parameters:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"vocabulary")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"optim_conf"))),(0,i.kt)("p",null,"On the one hand, ",(0,i.kt)("inlineCode",{parentName:"p"},"vocabulary")," is not something you usually know beforehand, as it will be automatically built by ",(0,i.kt)("inlineCode",{parentName:"p"},"classy")," itself.\nOn the other hand, ",(0,i.kt)("inlineCode",{parentName:"p"},"optim_conf")," is your optimizer configuration, whose instantiation involves instantiating a PyTorch optimizer;\nhowever, this latter operation is impossible as PyTorch optimizers take model parameters as input to their constructors,\nwhich you don't have yet as the model and its weights are exactly what you are trying to instantiate."),(0,i.kt)("p",null,"Yet, this code and configuration work, despite the missing ",(0,i.kt)("inlineCode",{parentName:"p"},"vocabulary")," field and the circle dependency with ",(0,i.kt)("inlineCode",{parentName:"p"},"optim_conf"),".\nThis is because, first, ",(0,i.kt)("inlineCode",{parentName:"p"},"classy")," knows it should pass the built vocabulary along the other instantiation params, and manually adds it\nwhen instantiating classy models."),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"When facing instantiation issues similar to this ",(0,i.kt)("inlineCode",{parentName:"p"},"vocabulary")," thing, you can apply this pattern to deal with them,\nmanually passing the additional parameter via kwargs to ",(0,i.kt)("inlineCode",{parentName:"p"},"hydra.utils.instantiate(...)"),".")),(0,i.kt)("p",null,"Second, ",(0,i.kt)("inlineCode",{parentName:"p"},"classy")," disables recursive instantiation on models, meaning that ",(0,i.kt)("inlineCode",{parentName:"p"},"optim_conf")," will not be instantiated automatically.\nRather, ",(0,i.kt)("inlineCode",{parentName:"p"},"__init__")," will receive a DictConfig object and will have to take care itself of instantiating it."))}p.isMDXComponent=!0}}]);